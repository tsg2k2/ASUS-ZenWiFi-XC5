SWITCH=DEVICE_0
export OUT_FNAME=$HOME/tc-check-amas_wgn.sh
echo -e "#!/bin/sh" >$OUT_FNAME
echo -e "wgn_enabled=\`nvram get wgn_enabled\`\nwl_ifnames=\`nvram get wl_ifnames\`\nvlan_rulelist=\`nvram get vlan_rulelist\`\nlan_ifnames=\`nvram get lan_ifnames\`\nre_mode=\`nvram get re_mode\`\neth_ifnames=\`nvram get eth_ifnames\`\nsta_phy_ifnames=\`nvram get sta_phy_ifnames\`\namas_path_stat=\`nvram get amas_path_stat\`\n" >>$OUT_FNAME
echo -e "get_unit_by_band() {\nnum5g=0\nnband=0\ni=0\nunit=0\nif [ \"\$1\" = \"2G\" ]; then\nnband=2\nelif [ \"\$1\" = \"5G\" ]; then\nnband=1\nelif [ \"\$1\" = \"5GH\" ]; then\nnband=1\nelif [ \"\$1\" = \"6G\" ]; then\nnband=4\nelse\nnband=-1\nfi\n IFS=\" \"\nfor word in \$wl_ifnames; do\nnv=\"wl\"\$unit\"_nband\"\ni=\`nvram get \$nv\`\nif [ \$i -eq \$nband ]; then\nif [ \$nband -eq 1 ]; then\nnum5g=\$((\$num5g+1))\nif [ \$num5g -eq 1 ]; then\nif [ \"\$1\" = \"5G\" ]; then\nreturn \$unit\nfi\n elif [ \$num5g -eq 2 ]; then\nif [ \"\$1\" = \"5GH\" ]; then\nreturn \$unit\nfi\nelse\nreturn -1\nfi\nelse\nreturn \$unit\nfi\nfi\nunit=\$((\$unit+1))\ndone\nreturn -1\n}\n" >>$OUT_FNAME
echo -e "get_fh_wlifnames_for_re() {\nresult=\"\"\nunit=0\nIFS=\" \"\nfor word in \$wl_ifnames; do\nresult=\$result\" wl\"\$unit\".1 \"\nunit=\$((\$unit+1))\ndone\n}\n" >>$OUT_FNAME
echo -e "get_wifi_band() {\nresult=\"\"\nnum5g=0\nunit=0\nIFS=\" \"\nfor word in \$wl_ifnames; do\nnv=\"wl\"\$unit\"_nband\"\nnband=\`nvram get \$nv\`\nif [ \$nband -eq 2 ]; then\nresult=\" 2G\"\nelif [ \$nband -eq 1 ]; then\nnum5g=\$((\$num5g+1))\nif [ \$num5g -eq 2 ]; then\nresult=\$result\" 5GH\"\nelse\nresult=\$result\" 5G\"\nfi\nelif [ \$nband -eq 4 ]; then\nresult=\$result\" 6G\"\nelse\nresult=\$result\nfi\nunit=\$((\$unit+1))\ndone\necho \$result\n}\n" >>$OUT_FNAME
echo -e "have_band() {\nwifi_band=\$(get_wifi_band)\nIFS=\" \"\nfor word in \$wifi_band; do\nif [ \"\$word\" = \"\$1\" ]; then\nreturn 1\nfi\ndone\nreturn 0\n}\n" >>$OUT_FNAME
echo -e "check_if_addr() {\nstr=\`ifconfig \$1 | grep \'inet \' | sed \'s/^.*inet addr://g\'\`\nIFS=\" \"\nfor word in \$str; do\nif [ \"\$word\" = \"\$2\" ]; then\nreturn 1\nelse\nreturn 0\nfi\ndone\n}\n" >>$OUT_FNAME
echo -e "get_br_ifnames() {\nresult=\"\"\nBR_DIR=\"/sys/class/net/\"\$1\"/brif/*\"\nfor FILE in \$BR_DIR; do\nresult=\$result\" \"\$(basename \${FILE});\ndone\necho \$result\n}\n" >>$OUT_FNAME
echo -e "ifexists() {\nif [ -z \$(\`ifconfig | grep enc | grep \$1\`) ]; then\n return 0\nelse\nreturn 1\nfi\n}\n" >>$OUT_FNAME
echo -e "ifexists_in_br() {\nresult=\$(get_br_ifnames \"\$1\")\nIFS=\" \"\nfound=0\nfor word in \$result; do\nif [ \"\$2\" = \"\$word\" ]; then\nfound=1\nfi\ndone\nreturn \$found\n}\n" >>$OUT_FNAME
echo -e "is_wlif() {\nunit=0\nIFS=\" \"\nfor word in \$wl_ifnames; do\nif [ \"\$1\" = \"\$word\" ]; then\nreturn 1\nfi\nnv=\"wl\"\$unit\"_vifnames\"\nvifname=\`nvram get \$nv\`\nfor word2 in \$vifname; do\nif [ \"\$1\" = \"\$word2\" ]; then\nreturn 1\nfi\ndone\nunit=\$((\$unit+1))\ndone\nreturn 0\n}\n" >>$OUT_FNAME
echo -e "get_fh_wl_ifnames() {\nresult=\"\"\nif [ \$re_mode -eq 0 ]; then\nifnames=\$wl_ifnames\nelse\necho \$get_fh_wlifnames_for_re\nfi\nIFS=\" \"\nfor word in \$ifnames; do\nis_wlif \$word\nif [ \$? -eq 1 ]; then\nresult=\$result\" \"\$word\nfi\ndone\necho \$result\n}\n" >>$OUT_FNAME
echo -e "get_fh_eth_ifnames() {\nstr1=\"\"\nIFS=\" \"\nfor word5 in \$lan_ifnames; do\nis_wlif \$word5\nif [ \$? -eq 0 ]; then\nstr1=\$str1\" \"\$word5\nfi\ndone\nstr2=\"\"\nIFS=\" \"\nfor word5 in \$str1; do\nif [ \"\$word5\" = \"vlan1\" ]; then\nstr2=\$str2\" eth0\"\nelse\nstr2=\$str2\" \"\$word5\nfi\ndone\nresult=\"\"\nIFS=\" \"\nfor word5 in \$str2; do\nIFS=\" \"\nfor word6 in \$eth_ifnames; do\nif [ \"\$word5\" != \"\$word6\" ]; then\nresult=\$result\" \"\$word5\nfi\ndone\ndone\necho \$result\n}\n" >>$OUT_FNAME
echo -e "get_bh_wl_ifnames() {\nresult=\"\"\nif [ \$re_mode -eq 1 ]; then\nresult=\$sta_phy_ifnames\nfi\necho \$result\n}\n" >>$OUT_FNAME
echo -e "get_bh_eth_ifnames() {\nresult=\"\"\nIFS=\" \"\nfor word in \$eth_ifnames; do\nif [ \"\$word\" = \"vlan2\" ]; then\nresult=\$result\" eth0\"\nelse\nresult=\$result\" \"\$word\nfi\ndone\necho \$result\n}\n" >>$OUT_FNAME
echo -e "num_of_wifi_band() {\nnum=0\nIFS=\" \"\nfor word in \$wl_ifnames; do\nnum=\$((\$num+1))\ndone\nreturn \$num\n}\n" >>$OUT_FNAME
echo -e "#check vlan_rulelist\nrl_count=0\nfound=0\nWGN_RL=\"\"\nIFS=\"<\"\nbr_idx=0\nfor word in \$vlan_rulelist; do\nvid=\"\"\nvif=\"\"\nbrip=\"\"\nfound2=0\nfield=1\nIFS=\">\"\nif [ \$re_mode -eq 0 ]; then\nsubunit=1\nelse\nsubunit=2\nfi\n" >>$OUT_FNAME
echo -e "for word2 in \$word; do\nif [ \$field -eq 2 ]; then\nvid=\$word2\nfi\nif [ \$field -eq 6 ]; then\nif [ \"\$word2\" = \"0002\" ]; then\nhave_band \"2G\"\nif [ \$? -eq 1 ]; then\nget_unit_by_band \"2G\"\nunit=\$?\nif [ \$unit -ne -1 ]; then\nvif=\"wl\"\$unit\".\"\$subunit\nfound=1\nfound2=1\nfi\n\nelse\necho \"Failed to check vlan_rulelist (WIFI 2G)\"\nexit 0\nfi\nfi\nfi\n" >>$OUT_FNAME
echo -e "if [ \$field -eq 7 ]; then\nif [ \"\$word2\" = \"0002\" ]; then\nhave_band \"5G\"\nif [ \$? -eq 1 ]; then\nget_unit_by_band \"5G\"\nunit=\$?\nif [ \$unit -ne -1 ]; then\nvif=\"wl\"\$unit\".\"\$subunit\nfound=1\nfound2=1\nfi\n\nelse\necho \"Failed to check vlan_rulelist (WIFI 5G)\"\nexit 0\nfi\nelif [ \"\$word2\" = \"00000002\" ]; then\nhave_band \"5GH\"\nif [ \$? -eq 1 ]; then\nget_unit_by_band \"5GH\"\nunit=\$?\nif [ \$unit -ne -1 ]; then\nvif=\"wl\"\$unit\".\"\$subunit\nfound=1\nfound2=1\nfi\nelse\necho \"Failed to check vlan_rulelist (WIFI 5GH)\"\nexit0\nfi\nelif [ \"\$word2\" = \"000000000002\" ]; then\nhave_band \"6G\"\nif [ \$? -eq 1 ]; then\nget_unit_by_band \"6G\"\nunit=\$?\nif [ \$unit -ne -1 ]; then\nvif=\"wl\"\$unit\".\"\$subunit\nfound=1\nfound2=1\nfi\nelse\necho \"Failed to check vlan_rulelist (WIFI 6G)\"\nexit 0\nfi\nelse\nfound=0\nfi\nfi\n" >>$OUT_FNAME
echo -e "if [ \$field -eq 8 ]; then\nfield2=0\nIFS=\"/\"\nfor word3 in \$word2; do\nif [ \$field2 -eq 0 ]; then\nbrip=\$word3\nfound=1\nfound2=1\nfi\nfield2=\$((\$field2+1))\ndone\nfi\nfield=\$((\$field+1))\ndone\nif [ \$found2 -eq 1 ]; then\nrl_count=\$((\$rl_count+1))\nnv=\$vif\"_bss_enabled\"\nbss_enabled=\`nvram get \$nv\`\nif [ ! -z \"\$bss_enabled\" ] && [ \$bss_enabled -eq 1 ]; then\n WGN_ON_RL=\$WGN_ON_RL\"<br\"\$br_idx\">\"\$vid\">\"\$vif\">\"\$brip\nelse\nWGN_OFF_RL=\$WGN_OFF_RL\"<br\"\$br_idx\">\"\$vid\">\"\$vif\">\"\$brip\nfi\nfi\nbr_idx=\$((\$br_idx+1))\ndone\n" >>$OUT_FNAME
echo -e "if  [ \$found -eq 0 ]; then\necho \"Failed to check vlan_rulelist\"\nexit 0\nfi\nnum_of_wifi_band\nif [ \$? -ne \$rl_count ]; then\necho \"Failed to check vlan_rulelist list count\"\nexit 0\nfi\necho \"WGN_ON_RL=\"\$WGN_ON_RL\necho \"WGN_OFF_RL=\"\$WGN_OFF_RL\n#WGN_RL=<br2>501>wl0.1>192.168.101.1<br3>502>wl0.1>192.168.102.1\n" >>$OUT_FNAME
echo -e "#check WGN Bridge\nIFS=\"<\"\nfor word in \$WGN_ON_RL; do\nfield=1\nbr_name=\"\"\nvid=\"\"\nvif=\"\"\nbr_ip=\"\"\nIFS=\">\"\nfor word2 in \$word; do\nif [ \$field -eq 1 ]; then\nbr_name=\$word2\nelif [ \$field -eq 2 ]; then\nvid=\$word2\nelif [ \$field -eq 3 ]; then\ntmp=\$word2\"_ifname\"\nvif=\`nvram get \$tmp\`\nelif [ \$field -eq 4 ]; then\nbr_ip=\$word2\nelse\nbr_name=\"\"\nvid=\"\"\nvif=\"\"\nbr_ip=\"\"\nfi\nfield=\$((\$field+1))\ndone\n" >>$OUT_FNAME
echo -e "if [ ! -z \"\$br_name\" ] && [ ! -z \"\$vid\" ] && [ ! -z \"\$vif\" ] && [ ! -z \"\$br_ip\" ]; then\n# check WGN bridge(FH WIFI IF)\nIFS=\" \"\nfor word3 in \$(get_fh_wl_ifnames); do\nfh_if=\$word3\".\"\$vid\nifexists_in_br \$br_name \$fh_if\nif [ \$? -eq 0 ]; then\necho \"Failed to check WGN bridge(FH WIFI IF)\"\nexit 0\nfi\ndone\n# check WGN bridge(FH ETH IF)\nIFS=\" \"\nfor word3 in \$(get_fh_eth_ifnames); do\n fh_if=\$word3\".\"\$vid\nifexists_in_br \$br_name \$fh_if\nif [ \$? -eq 0 ]; then\necho \"Failed to check WGN bridge(FH ETH IF)\"\nexit 0\nfi\ndone\n# check WGN bridge(VIF)\nifexists_in_br \$br_name \$vif\nif [ \$? -eq 0 ]; then\necho \"Failed to check WGN bridge(VIF)\"\nexit 0\nfi\n" >>$OUT_FNAME
echo -e "#check BH IF\nif [ \$re_mode -eq 1 ]; then\nfound=0\nfound2=0\nif [ \$amas_path_stat -ne 1 ]; then\nfor word3 in \$(get_bh_wl_ifnames); do\nifexists_in_br \$br_name \$word3\".\"\$vid\nif [ \$? -ne 0 ]; then\nfound=1\nfi\nifexists_in_br \"br0\" \$word3\nif [ \$? -ne 0 ]; then\nfound2=1\nelse\nifexists_in_br \"br0\" \$word3\".0\"\nif [ \$? -ne 0 ]; then\nfound2=1\nfi\nfi\ndone\nif [ \$found -eq 0 ] || [ \$found2 -eq 0 ]; then\n if [ \$found -eq 0 ]; then\necho \"Failed to check WGN Bridge(BH WIFI IF)\"\nexit 0\nfi\n" >>$OUT_FNAME
echo -e "if [ \$found2 -eq 0 ]; then\necho \"Failed to check br0(BH WIFI IF)\"\nexit 0\nfi\nfi\nelse\nfor word3 in \$(get_bh_eth_ifnames); do\nifexists_in_br \$br_name \$word3\".\"\$vid\nif [ \$? -eq 1 ]; then\nfound=1\nfi\nifexists_in_br \"br0\" \$word3\nif [ \$? -eq 1 ]; then\nfound2=1\nfi\ndone\nif [ \$found -eq 0 ] || [ \$found2 -eq 0]; then\n if [ \$found -eq 0 ]; then\necho \"Failed to check WGN Bridge(BH ETH IF)\"\nexit 0\nfi\nif [ \$found2 -eq 0 ]; then\necho \"Failed to check br0(BH ETH IF)\"\nexit 0\nfi\nfi\nfi\nfi\nfi\ndone\n" >>$OUT_FNAME
echo -e "IFS=\"<\"\nfor word in \$WGN_OFF_RL\n do\nfield=1\nbr_name=\"\"\nvid=\"\"\nvif=\"\"\nbr_ip=\"\"\nIFS=\">\"\nfor word2 in \$word\n do\nif [ \$field -eq 1 ]; then\nbr_name=\$word2\nelif [ \$field -eq 2 ]; then\nvid=\$word2\nelif [ \$field -eq 3 ]; then\ntmp=\$word2\"_ifname\"\nvif=\`nvram get \$tmp\`\nelif [ \$field -eq 4 ]; then\nbr_ip=\$word2\nelse\nbr_name=\"\"\nvid=\"\"\nvif=\"\"\nbr_ip=\"\"\nfi\nfield=\$((\$field+1))\ndone\n" >>$OUT_FNAME
echo -e "if [ ! -z \"\$br_name\" ] && [ ! -z \"\$vid\" ] && [ ! -z \"\$vif\" ] && [ ! -z \"\$br_ip\" ]; then\n# check disable WGN Bridge\nifexists \$br_name\nif [ \$? -eq 1 ]; then\necho \"Failed to check disable WGN Bridge --> \"\$br_name\nexit 0\nfi\n# check disable WGN(FH WIFI IF)\nIFS=\" \"\nfor word3 in \$(get_fh_wl_ifnames); do\nifexists \$word3\".\"\$vid\nif [ \$? -eq 1 ]; then\necho \"Failed to check disable WGN(FH WIFI IF) --> \"\$word3\".\"\$vid\nexit 0\nfi\ndone\n# check disable WGN(FH ETH IF)\nfh_eth_ifnames=\$(get_fh_eth_ifnames)\nIFS=\" \"\nfor word3 in \$fh_eth_ifnames; do\nifexists \$word3\".\"\$vid\nif [ \$? -eq 1 ]; then\necho \"Failed to check disable WGN(FH ETH IF) --> \"\$word3\".\"\$vid\nexit 0\nfi\ndone\n" >>$OUT_FNAME
echo -e "#check BH IF\nif [ \$re_mode -eq 1 ]; then\nfound=0\nfound2=0\nif [ \$amas_path_stat -ne 1 ]; then\nfor word3 in \$(get_bh_wl_ifnames); do\nifexists \$word3\".\"\$vid\nif [ \$? -eq 1 ]; then\necho \"Failed to check Disable WGN for BH IF\"\nexit 0\nfi\nifexists \$word3\".0\"\nif [ \$? -eq 1 ]; then\necho \"Failed to check Disable WGN for BH IF\"\nexit 0\nfi\ndone\nelse\nfor word3 in \$(get_bh_eth_ifnames); do\nifexists \$word3\".\"\$vid\nif [ \$? -eq 1 ]; then\necho \"Failed to check Disable WGN for BH IF\"\nexit 0\nfi\nifexists \$word3\nif [ \$? -eq 1 ]; then\necho \"Failed to check Disable WGN for BH IF\"\nexit 0\nfi\ndone\nfi\nfi\nfi\ndone\n" >>$OUT_FNAME
echo -e "echo \"OK\"\nexit 1\n" >>$OUT_FNAME
chmod 777 $OUT_FNAME
