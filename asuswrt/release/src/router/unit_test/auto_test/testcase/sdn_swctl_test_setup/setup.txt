SWITCH=DEVICE_0
export SCRIPT_NAME=$HOME/tc-check-swctl.sh
echo -e "#!/bin/sh" >$SCRIPT_NAME
echo -e "usage=\"Usage: \"\$0\" sdn_vid access/trunk ethernet port index(ex.1,2,3)\"\nnv_wired_ifnames=\`nvram get wired_ifnames\`\nnv_apg_br_info=\`nvram get apg_br_info\`\nre_mode=\`nvram get re_mode\`\n\nget_wired_ifnames_by_idx() {\nresult=\"\"\ncount=1\nIFS=\" \"\nfor word in \$nv_wired_ifnames; do\nif [ \$count -eq \$1 ]; then\nresult=\$word\nbreak\nfi\ncount=\$((\$count+1))\ndone\necho \$result\n}\n" >>$SCRIPT_NAME
echo -e "get_apg_br_ifnames() {\nresult=\"\"\nIFS=\"<\"\nfor word in \$nv_apg_br_info; do\nfield=1\nIFS=\">\"\nfor word2 in \$word; do\nif [ \$field -eq 2 ]; then\nresult=\$result\$word2\" \"\nfi\nfield=\$((\$field+1))\ndone\ndone\necho \$result\n}\n\nget_apg_vid_by_brname() {\nresult=\"\"\nIFS=\"<\"\nfor word in \$nv_apg_br_info; do\nresult=\"\"\nfound=0\nfield=1\nIFS=\">\"\nfor word2 in \$word; do\nif [ \$field -eq 1 ]; then\nresult=\$word2\nfi\nif [ \$field -eq 2 ]; then\nif [ \$word2 = \$1 ]; then\nfound=1\nbreak\nfi\nfi\nfield=\$((\$field+1))\ndone\nif [ \$found -eq 1 ]; then\n break\nfi\ndone\necho \$result\n}\n" >>$SCRIPT_NAME
echo -e "get_apg_brname_by_vid() {\nresult=\"\"\nif [ \$re_mode -eq 0 ]; then\nIFS=\"<\"\nfor word in \$nv_apg_br_info; do\nfound=0\nfield=1\nIFS=\">\"\nfor word2 in \$word; do\nif [ \$field -eq 1 ]; then\nif [ \$word2 = \$1 ]; then\nfound=1\nelse\nbreak\nfi\nfi\nif [ \$field -eq 2 ]; then\nif [ \$found -eq 1 ]; then\nresult=\$word2\nbreak\nfi\nfi\nfield=\$((\$field+1))\ndone\ndone\nelse\nresult=\"br\"\$1\nfi\necho \$result\n}\n\nget_br_ifnames() {\nresult=\"\"\nBR_DIR=\"/sys/class/net/\"\$1\"/brif/*\"\nfor FILE in \$BR_DIR; do\nresult=\$result\" \"\$(basename \${FILE});\ndone\necho \$result\n}\n\nifexists_in_br() {\nresult=\$(get_br_ifnames \"\$1\")\nIFS=\" \"\nfound=0\nfor word in \$result; do\nif [ \"\$2\" = \"\$word\" ]; then\nfound=1\nfi\ndone\nreturn \$found\n}\nif [ -z \$1 ] | [ -z \$2 ] | [ -z \$3 ]; then\necho \$usage\nexit 0\nfi\n" >>$SCRIPT_NAME
echo -e "brname=\$(get_apg_brname_by_vid \"\$1\")\nif [ -z \$brname ]; then\necho \"not found vid \"\$1\nexit 0\nfi\n" >>$SCRIPT_NAME
echo -e "IFS=\",\"\nif [ \$2 = \"access\" ]; then\nfor word3 in \$3; do\nifname=\$(get_wired_ifnames_by_idx \"\$word3\")\nifexists_in_br \"br0\" \$ifname\nif [ \$? -eq 1 ]; then\necho \"Failed to access mode, \"\$ifname\" exists in br0\"\nexit 0\nfi\nifexists_in_br \$brname \$ifname\nif [ \$? -eq 0 ]; then\necho \"Failed to access mode, \"\$ifname\" is not found in \"\$brname\nexit 0\nfi\ndone" >>$SCRIPT_NAME
echo -e "elif [ \$2 = \"trunk\" ]; then\nIFS=\",\"\nfor word3 in \$3; do\nifname=\$(get_wired_ifnames_by_idx \"\$word3\")\nifexists_in_br \"br0\" \$ifname\nif [ \$? -eq 1 ]; then\necho \"Failed to trunk mode, \"\$ifname\" exists in br0\"\nexit 0\nfi\nifexists_in_br \$brname \$ifname\nif [ \$? -eq 1 ]; then\necho \"Failed to trunk mode, \"\$ifname\" exists in \"\$brname\nexit 0\nfi\nifexists_in_br \$brname \$ifname\".\"\$1\nif [ \$? -eq 0 ]; then\necho \"Failed to trunk mode, \"\$ifname\".\"\$1\" is not found in \"\$brname\nexit 0\nfi\nIFS=\" \"\nfor word4 in \$(get_apg_br_ifnames); do\nif [ ! \$word4 = \$brname ]; then\nvid=\$(get_apg_vid_by_brname \"\$word4\")\nif [ ! -z \$vid ]; then\n  ifexists_in_br \$word4 \$ifname\".\"\$vid\nif [ \$? -eq 1 ]; then\necho \"Failed to trunk mode, \"\$ifname\".\"\$vid\" exists in \"\$word4\nexit 0\nfi\n fi\nfi\ndone\n done" >>$SCRIPT_NAME
echo -e "elif [ \$2 = \"default\" ]; then\nIFS=\",\"\nfor word3 in \$3; do\nifname=\$(get_wired_ifnames_by_idx \"\$word3\")\nifexists_in_br \"br0\" \$ifname\nif [ \$? -eq 0 ]; then\necho \"Failed to default mode, \"\$ifname\" is not found in br0\"\nexit 0\nfi\nifexists_in_br \$brname \$ifname\".\"\$1\nif [ \$? -eq 0 ]; then\necho \"Failed to default mode, \"\$ifname\".\"\$1\" is not found in \"\$brname\nexit 0\nfi\ndone\nelse\necho \$usage\nexit 0\nfi\necho \"OK\"\nexit 1" >>$SCRIPT_NAMESWITCH=DEVICE_1
SWITCH=DEVICE_1
export SCRIPT_NAME=$HOME/tc-check-swctl.sh
echo -e "#!/bin/sh" >$SCRIPT_NAME
echo -e "usage=\"Usage: \"\$0\" sdn_vid access/trunk ethernet port index(ex.1,2,3)\"\nnv_wired_ifnames=\`nvram get wired_ifnames\`\nnv_apg_br_info=\`nvram get apg_br_info\`\nre_mode=\`nvram get re_mode\`\n\nget_wired_ifnames_by_idx() {\nresult=\"\"\ncount=1\nIFS=\" \"\nfor word in \$nv_wired_ifnames; do\nif [ \$count -eq \$1 ]; then\nresult=\$word\nbreak\nfi\ncount=\$((\$count+1))\ndone\necho \$result\n}\n" >>$SCRIPT_NAME
echo -e "get_apg_br_ifnames() {\nresult=\"\"\nIFS=\"<\"\nfor word in \$nv_apg_br_info; do\nfield=1\nIFS=\">\"\nfor word2 in \$word; do\nif [ \$field -eq 2 ]; then\nresult=\$result\$word2\" \"\nfi\nfield=\$((\$field+1))\ndone\ndone\necho \$result\n}\n\nget_apg_vid_by_brname() {\nresult=\"\"\nIFS=\"<\"\nfor word in \$nv_apg_br_info; do\nresult=\"\"\nfound=0\nfield=1\nIFS=\">\"\nfor word2 in \$word; do\nif [ \$field -eq 1 ]; then\nresult=\$word2\nfi\nif [ \$field -eq 2 ]; then\nif [ \$word2 = \$1 ]; then\nfound=1\nbreak\nfi\nfi\nfield=\$((\$field+1))\ndone\nif [ \$found -eq 1 ]; then\n break\nfi\ndone\necho \$result\n}\n" >>$SCRIPT_NAME
echo -e "get_apg_brname_by_vid() {\nresult=\"\"\nif [ \$re_mode -eq 0 ]; then\nIFS=\"<\"\nfor word in \$nv_apg_br_info; do\nfound=0\nfield=1\nIFS=\">\"\nfor word2 in \$word; do\nif [ \$field -eq 1 ]; then\nif [ \$word2 = \$1 ]; then\nfound=1\nelse\nbreak\nfi\nfi\nif [ \$field -eq 2 ]; then\nif [ \$found -eq 1 ]; then\nresult=\$word2\nbreak\nfi\nfi\nfield=\$((\$field+1))\ndone\ndone\nelse\nresult=\"br\"\$1\nfi\necho \$result\n}\n\nget_br_ifnames() {\nresult=\"\"\nBR_DIR=\"/sys/class/net/\"\$1\"/brif/*\"\nfor FILE in \$BR_DIR; do\nresult=\$result\" \"\$(basename \${FILE});\ndone\necho \$result\n}\n\nifexists_in_br() {\nresult=\$(get_br_ifnames \"\$1\")\nIFS=\" \"\nfound=0\nfor word in \$result; do\nif [ \"\$2\" = \"\$word\" ]; then\nfound=1\nfi\ndone\nreturn \$found\n}\nif [ -z \$1 ] | [ -z \$2 ] | [ -z \$3 ]; then\necho \$usage\nexit 0\nfi\n" >>$SCRIPT_NAME
echo -e "brname=\$(get_apg_brname_by_vid \"\$1\")\nif [ -z \$brname ]; then\necho \"not found vid \"\$1\nexit 0\nfi\n" >>$SCRIPT_NAME
echo -e "IFS=\",\"\nif [ \$2 = \"access\" ]; then\nfor word3 in \$3; do\nifname=\$(get_wired_ifnames_by_idx \"\$word3\")\nifexists_in_br \"br0\" \$ifname\nif [ \$? -eq 1 ]; then\necho \"Failed to access mode, \"\$ifname\" exists in br0\"\nexit 0\nfi\nifexists_in_br \$brname \$ifname\nif [ \$? -eq 0 ]; then\necho \"Failed to access mode, \"\$ifname\" is not found in \"\$brname\nexit 0\nfi\ndone" >>$SCRIPT_NAME
echo -e "elif [ \$2 = \"trunk\" ]; then\nIFS=\",\"\nfor word3 in \$3; do\nifname=\$(get_wired_ifnames_by_idx \"\$word3\")\nifexists_in_br \"br0\" \$ifname\nif [ \$? -eq 1 ]; then\necho \"Failed to trunk mode, \"\$ifname\" exists in br0\"\nexit 0\nfi\nifexists_in_br \$brname \$ifname\nif [ \$? -eq 1 ]; then\necho \"Failed to trunk mode, \"\$ifname\" exists in \"\$brname\nexit 0\nfi\nifexists_in_br \$brname \$ifname\".\"\$1\nif [ \$? -eq 0 ]; then\necho \"Failed to trunk mode, \"\$ifname\".\"\$1\" is not found in \"\$brname\nexit 0\nfi\nIFS=\" \"\nfor word4 in \$(get_apg_br_ifnames); do\nif [ ! \$word4 = \$brname ]; then\nvid=\$(get_apg_vid_by_brname \"\$word4\")\nif [ ! -z \$vid ]; then\n  ifexists_in_br \$word4 \$ifname\".\"\$vid\nif [ \$? -eq 1 ]; then\necho \"Failed to trunk mode, \"\$ifname\".\"\$vid\" exists in \"\$word4\nexit 0\nfi\n fi\nfi\ndone\n done" >>$SCRIPT_NAME
echo -e "elif [ \$2 = \"default\" ]; then\nIFS=\",\"\nfor word3 in \$3; do\nifname=\$(get_wired_ifnames_by_idx \"\$word3\")\nifexists_in_br \"br0\" \$ifname\nif [ \$? -eq 0 ]; then\necho \"Failed to default mode, \"\$ifname\" is not found in br0\"\nexit 0\nfi\nifexists_in_br \$brname \$ifname\".\"\$1\nif [ \$? -eq 0 ]; then\necho \"Failed to default mode, \"\$ifname\".\"\$1\" is not found in \"\$brname\nexit 0\nfi\ndone\nelse\necho \$usage\nexit 0\nfi\necho \"OK\"\nexit 1" >>$SCRIPT_NAME